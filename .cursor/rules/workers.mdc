---
alwaysApply: false
description: "Workers package specific patterns for database batch operations and validation"
globs: packages/workers/src/**
---

# Workers Package Rules

> **For comprehensive database patterns**, see the [Database Guide](/guides/database) in the docs site.
> This file provides quick reference patterns for AI agents.

## Drizzle Transactions

**ALWAYS use `db.batch()` for multiple related database operations** to ensure atomicity:

```javascript
// DO: Use batch for related operations
const batchOps = [
  db.insert(projects).values({ id, name, createdBy }),
  db.insert(projectMembers).values({ projectId: id, userId, role: 'owner' }),
];
await db.batch(batchOps);

// DON'T: Separate operations
await db.insert(projects).values({ id, name });
await db.insert(projectMembers).values({ projectId: id, userId });
```

Use batch when operations must be atomic (all succeed or all fail). Single independent operations don't need batch.

## Zod Validation

**ALWAYS validate request bodies** using `validateRequest` middleware:

```javascript
// DO: Use middleware
import { validateRequest, projectSchemas } from '../config/validation.js';

projectRoutes.post('/', validateRequest(projectSchemas.create), async c => {
  const data = c.get('validatedBody'); // Already validated
});

// DON'T: Manual validation
projectRoutes.post('/', async c => {
  const body = await c.req.json();
  // Manual checks...
});
```

**Add new schemas to `config/validation.js`** and reuse `commonFields` when possible. Use `validateQueryParams` for query parameters.

## Organization-Scoped Routes

All project routes are org-scoped under `/api/orgs/:orgId/...`. Use `requireOrgMembership` and `requireProjectAccess` middleware instead of manual membership checks.

```js
import { requireOrgMembership, requireProjectAccess, getOrgContext } from '../middleware/requireOrg.js';

// Org membership is checked by middleware - don't duplicate in handler
orgProjectRoutes.post('/', requireOrgMembership(), validateRequest(schema), async c => {
  const { orgId } = getOrgContext(c);
  // orgId is guaranteed valid and user has access
});
```

See `organizations.mdc` for detailed org/project patterns.

## Examples

- See `src/routes/orgs/projects.js` for org-scoped project routes
- See `src/routes/orgs/members.js` for project member management
- See `src/routes/account-merge.js` for batch usage

## Related Documentation

- [Organizations Guide](/guides/organizations) - Org model, routes, and middleware
- [Database Guide](/guides/database) - Comprehensive Drizzle ORM patterns, migrations, and schema management
- [API Development Guide](/guides/api-development) - API route patterns and validation
