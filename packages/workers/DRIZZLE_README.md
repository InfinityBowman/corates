# Drizzle ORM Setup and Workflow

This document explains how database schemas, migrations, and test helpers are managed using Drizzle ORM.

## Architecture: Single Source of Truth

The database schema follows a single source of truth pattern:

```
Drizzle Schema (src/db/schema.js)
    ↓
Migration SQL (migrations/0001_init.sql)
    ↓
Test SQL Constant (src/__tests__/migration-sql.js) [generated]
```

**Key Principle:** Only the Drizzle schema (`src/db/schema.js`) needs to be maintained manually. Everything else is generated from it.

## Files Overview

### Source Files (Maintained Manually)

- **`src/db/schema.js`** - Drizzle ORM schema definitions (TypeScript)
  - This is the single source of truth
  - All table definitions, columns, relationships, and constraints are defined here

- **`migrations/0001_init.sql`** - SQL migration file
  - Can be manually maintained OR generated using `drizzle-kit generate`
  - Used by Wrangler to apply migrations to D1 databases

### Generated Files (Auto-generated)

- **`src/__tests__/migration-sql.js`** - Test SQL constant
  - Generated by `scripts/generate-test-sql.mjs`
  - Exported as `MIGRATION_SQL` constant
  - Used by test helpers for database reset
  - **Do not edit manually** - it will be overwritten

## Available Scripts

### Generate Migration SQL from Schema

```bash
pnpm db:generate
```

This runs `drizzle-kit generate` which:
- Reads the Drizzle schema from `src/db/schema.js`
- Compares it with existing migrations
- Generates new migration SQL files in `migrations/`

**Note:** Currently, the project uses a single consolidated migration file (`0001_init.sql`). When making schema changes, you can either:
1. Manually edit `migrations/0001_init.sql` to match the schema
2. Use `drizzle-kit generate` and merge the generated SQL into `0001_init.sql`

### Generate Test SQL Constant

```bash
pnpm db:generate:test
```

This runs `scripts/generate-test-sql.mjs` which:
- Reads `migrations/0001_init.sql`
- Generates `src/__tests__/migration-sql.js` with the SQL as an exported constant
- Used by test helpers to reset the database schema in tests

**When to run:** After updating the migration SQL file, run this to update the test helpers.

## Workflow: Making Schema Changes

### Step 1: Update Drizzle Schema

Edit `src/db/schema.js` to add/modify tables, columns, or constraints:

```typescript
export const myTable = sqliteTable('my_table', {
  id: text('id').primaryKey(),
  name: text('name').notNull(),
  // ... other columns
});
```

### Step 2: Update Migration SQL

You have two options:

**Option A: Manual Update (Current Approach)**
- Edit `migrations/0001_init.sql` directly
- Add/update CREATE TABLE statements, indexes, etc.
- Keep it in sync with the Drizzle schema

**Option B: Use Drizzle Kit (Future)**
```bash
pnpm db:generate
```
- This generates migration files in `migrations/` directory
- Review and apply the generated SQL
- For this project, you may need to merge into `0001_init.sql`

### Step 3: Regenerate Test SQL Constant

After updating the migration SQL:

```bash
pnpm db:generate:test
```

This ensures test helpers use the latest schema.

### Step 4: Apply Migration to Database

**Local development:**
```bash
pnpm db:migrate
```

**Production:**
```bash
pnpm db:migrate:prod
```

## Test Helpers

Test seed functions use Drizzle ORM and Zod validation:

### Seed Functions

All seed functions (`seedUser`, `seedProject`, `seedProjectMember`, `seedSession`, `seedSubscription`) now:
- Use Drizzle ORM `insert()` operations (no raw SQL)
- Validate inputs with Zod schemas (`src/__tests__/seed-schemas.js`)
- Automatically convert timestamps and handle type transformations

### Example Usage

```javascript
import { seedUser, seedProject } from './helpers.js';

// Timestamps can be Date objects or Unix timestamps (seconds)
await seedUser({
  id: 'user-1',
  name: 'Test User',
  email: 'test@example.com',
  createdAt: Math.floor(Date.now() / 1000), // Unix timestamp
  updatedAt: Math.floor(Date.now() / 1000),
  role: 'researcher', // optional, defaults to 'researcher'
  emailVerified: true, // boolean or 0/1
});

await seedProject({
  id: 'project-1',
  name: 'Test Project',
  description: 'A test project',
  createdBy: 'user-1',
  createdAt: Math.floor(Date.now() / 1000),
  updatedAt: Math.floor(Date.now() / 1000),
});
```

### Validation

All seed function parameters are validated using Zod schemas:
- Required fields are enforced
- Email format is validated
- Enums (roles, tiers, statuses) are validated
- Timestamps accept both Date objects and Unix timestamps
- Boolean fields accept both boolean and number (0/1) values

## Configuration

### Drizzle Kit Config

`drizzle.config.ts`:
```typescript
export default defineConfig({
  dialect: 'sqlite',
  schema: './src/db/schema.js',
  out: './migrations',
});
```

### Dependencies

- **`drizzle-orm`** - ORM for database operations (runtime)
- **`drizzle-kit`** - CLI tool for migrations (dev dependency)

## Best Practices

1. **Always update the schema first** - Edit `src/db/schema.js` before migration SQL
2. **Keep migrations in sync** - Ensure `migrations/0001_init.sql` matches the schema
3. **Regenerate test SQL** - Run `pnpm db:generate:test` after migration changes
4. **Use Drizzle ORM in tests** - Seed functions use Drizzle, not raw SQL
5. **Validate inputs** - All seed functions validate with Zod schemas

## Troubleshooting

### Test SQL is out of sync

If tests fail with schema errors:
```bash
pnpm db:generate:test
```

### Migration SQL doesn't match schema

1. Review `src/db/schema.js` for the intended schema
2. Update `migrations/0001_init.sql` to match
3. Run `pnpm db:generate:test` to update test helpers

### Seed function validation errors

Check the Zod schema in `src/__tests__/seed-schemas.js`:
- Required fields must be provided
- Enums must match valid values
- Timestamps can be Date objects or Unix timestamps (seconds)

## Related Files

- `src/db/schema.js` - Drizzle schema definitions
- `src/db/client.js` - Drizzle client factory
- `src/__tests__/helpers.js` - Test utilities and seed functions
- `src/__tests__/seed-schemas.js` - Zod validation schemas for seed functions
- `src/__tests__/migration-sql.js` - Generated test SQL constant (do not edit)
- `scripts/generate-test-sql.mjs` - Script to generate test SQL constant
- `drizzle.config.ts` - Drizzle Kit configuration
