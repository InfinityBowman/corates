#!/usr/bin/env node
/**
 * Generate test SQL constant from migration file
 * Reads the migration SQL and creates a JS file that exports it for test helpers
 */

import { readFileSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const MIGRATION_FILE = join(__dirname, '..', 'migrations', '0001_init.sql');
const OUTPUT_FILE = join(__dirname, '..', 'src', '__tests__', 'migration-sql.js');

try {
  // Read the migration SQL file
  const migrationSql = readFileSync(MIGRATION_FILE, 'utf-8');

  // Generate the JS file with the SQL as an exported constant
  const jsContent = `/**
 * Generated migration SQL for test helpers
 * This file is auto-generated by scripts/generate-test-sql.mjs
 * DO NOT EDIT MANUALLY - it will be overwritten
 *
 * To regenerate: pnpm db:generate:test
 */

export const MIGRATION_SQL = \`${migrationSql.replace(/`/g, '\\`').replace(/\${/g, '\\${')}\`;
`;

  // Write the generated file
  writeFileSync(OUTPUT_FILE, jsContent, 'utf-8');

  // eslint-disable-next-line no-undef
  console.log(`Generated test SQL constant: ${OUTPUT_FILE}`);
} catch (error) {
  // eslint-disable-next-line no-undef
  console.error('Error generating test SQL constant:', error.message);
  // eslint-disable-next-line no-undef
  process.exit(1);
}
